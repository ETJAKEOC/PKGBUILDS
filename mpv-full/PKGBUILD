pkgname=mpv-full
pkgver=0.41.0.46.g72efbfd009
pkgrel=1
pkgdesc='A free, open source, and cross-platform media player (with all possible libs)'
arch=('x86_64')
license=('GPL-2.0-or-later')
url='https://mpv.io/'
depends=('alsa-lib' 'ffmpeg' 'gcc-libs' 'glibc' 'hicolor-icon-theme' 'jack' 'lcms2' 'libarchive' 'libass' 'libbluray' 'libcaca' 'libcdio' 'libcdio-paranoia' 'libdisplay-info' 'libdrm' 'libdvdnav' 'libgl' 'libjpeg' 'libpipewire' 'libplacebo' 'libpulse' 'libsixel' 'libva' 'libvdpau' 'libx11' 'libxext' 'libxkbcommon' 'libxpresent' 'libxrandr' 'libxss' 'libxv' 'lua52' 'mesa' 'mujs' 'openal' 'rubberband' 'sdl2-compat' 'sh' 'sndio' 'uchardet' 'vapoursynth' 'vulkan-icd-loader' 'wayland' 'zimg' 'zlib')
makedepends=('ffnvcodec-headers' 'git' 'ladspa' 'meson' 'python-docutils' 'vulkan-headers' 'wayland-protocols' 'python-pyqt6' 'python-pyqtgraph')
optdepends=(
    'nvidia-utils: for hardware accelerated video decoding with CUDA'
    'python: for stats-conv and umpv scripts'
    'python-pyqt6: for stats-conv script'
    'python-pyqtgraph: for stats-conv script'
    'youtube-dl: for video-sharing websites playback'
    'yt-dlp: for video-sharing websites playback')
provides=('mpv')
conflicts=('mpv')
options=('!debug' '!docs' '!emptydirs' '!staticlibs' 'ccache' 'buildflags' 'lto' 'makeflags' 'strip')
source=("git+https://github.com/mpv-player/mpv.git")
sha256sums=('SKIP')

pkgver() {
    cd "$srcdir/mpv"
    git describe --always --tags --long | sed -e 's|^v||' -e 's|-|.|g'
}

prepare() {
  cd "$srcdir/mpv"
  git submodule update --init --recursive
}

build() {
    export CC=/usr/bin/clang
    export CPP=/usr/bin/clang-cpp
    export CXX=/usr/bin/clang++
    export LD=/usr/bin/lld
    export CC_LD=/usr/bin/lld
    export CXX_LD=/usr/bin/lld
    export AR=/usr/bin/llvm-ar
    export NM=/usr/bin/llvm-nm
    export STRIP=/usr/bin/llvm-strip
    export OBJCOPY=/usr/bin/llvm-objcopy
    export OBJDUMP=/usr/bin/llvm-objdump
    export READELF=/usr/bin/llvm-readelf
    export RANLIB=/usr/bin/llvm-ranlib
    export HOSTCC=/usr/bin/clang
    export HOSTCXX=/usr/bin/clang++
    export HOSTAR=/usr/bin/llvm-ar
    export HOSTLD=/usr/bin/lld
    export COMFLAGS="-march=znver2 -mtune=znver2 -pipe -O3 -g0 -flto=full"
    export CPPFLAGS="$COMFLAGS"
    export CFLAGS="$COMFLAGS"
    export CXXFLAGS="$COMFLAGS"
    export LDFLAGS="-fuse-ld=lld -O3 -Wl,--icf=all -Wl,--gc-sections -flto=full"

    meson "$srcdir/mpv" "$srcdir/build" -Dprefix=/usr -Dlibdir=/usr/lib \
        --optimization 3 \
        -Db_pie=true \
        -Db_staticpic=true \
        -Db_lto=true \
        -Dpython.bytecompile=2 \
        -Dbackend=ninja \
        -Db_colorout=always \
        -Dc_compiler="/usr/bin/clang" \
        -Dc_args="-march=znver2 -mtune=znver2 -pipe -O3 -g0 -flto=full" \
        -Dc_link_args="-fuse-ld=lld -O3 -Wl,--icf=all -Wl,--gc-sections -flto=full" \
        -Dcpp_args="-march=znver2 -mtune=znver2 -pipe -O3 -g0 -flto=full" \
        -Dcpp_link_args="-fuse-ld=lld -O3 -Wl,--icf=all -Wl,--gc-sections -flto=full" \
        -Dspirv-cross=disabled \
        -Dgpl=true \
        -Dcplayer=true \
        -Dlibmpv=true \
        -Dbuild-date=false \
        -Dtests=false \
        -Dfuzzers=false \
        -Damf=disabled \
        -Dcdda=enabled \
        -Dcplugins=enabled \
        -Ddvbin=enabled \
        -Ddvdnav=enabled \
        -Diconv=enabled \
        -Djavascript=enabled \
        -Dlcms2=enabled \
        -Dlibarchive=enabled \
        -Dlibbluray=enabled \
        -Dlua=luajit \
        -Daudiotrack=disabled \
        -Dpthread-debug=disabled \
        -Drubberband=enabled \
        -Dshaderc=disabled \
        -Duchardet=enabled \
        -Duwp=disabled \
        -Dvapoursynth=enabled \
        -Dvector=enabled \
        -Dwin32-threads=disabled \
        -Dzimg=enabled \
        -Dzlib=enabled \
        -Dalsa=enabled \
        -Dpipewire=enabled \
        -Dpulse=enabled \
        -Dopenal=enabled \
        -Dsdl2-audio=enabled \
        -Dsndio=enabled \
        -Djack=disabled \
        -Daaudio=disabled \
        -Daudiounit=disabled \
        -Dcoreaudio=disabled \
        -Davfoundation=disabled \
        -Dopensles=disabled \
        -Doss-audio=disabled \
        -Dwasapi=disabled \
        -Dcaca=enabled \
        -Ddrm=enabled \
        -Dgbm=enabled \
        -Degl=enabled \
        -Degl-drm=enabled \
        -Degl-wayland=enabled \
        -Degl-x11=enabled \
        -Dgl=enabled \
        -Dgl-x11=enabled \
        -Dplain-gl=enabled \
        -Dx11=enabled \
        -Dxv=enabled \
        -Dsdl2-video=enabled \
        -Ddmabuf-wayland=enabled \
        -Dcocoa=disabled \
        -Dd3d11=disabled \
        -Ddirect3d=disabled \
        -Dandroid-media-ndk=disabled \
        -Degl-android=disabled \
        -Degl-angle=disabled \
        -Degl-angle-lib=disabled \
        -Degl-angle-win32=disabled \
        -Dgl-cocoa=disabled \
        -Dgl-dxinterop=disabled \
        -Dgl-win32=disabled \
        -Dvaapi-win32=disabled \
        -Dsubrandr=disabled \
        -Dvdpau=enabled \
        -Dvdpau-gl-x11=enabled \
        -Dvaapi=enabled \
        -Dvaapi-drm=enabled \
        -Dvaapi-wayland=enabled \
        -Dvaapi-x11=enabled \
        -Dvulkan=enabled \
        -Dcuda-hwaccel=disabled \
        -Dcuda-interop=disabled \
        -Dd3d-hwaccel=disabled \
        -Dd3d9-hwaccel=disabled \
        -Dgl-dxinterop-d3d9=disabled \
        -Dios-gl=disabled \
        -Dvideotoolbox-gl=disabled \
        -Dvideotoolbox-pl=disabled \
        -Dhtml-build=disabled \
        -Dmanpage-build=enabled \
        -Dpdf-build=disabled \
        -Dmacos-10-15-4-features=disabled \
        -Dmacos-11-features=disabled \
        -Dmacos-11-3-features=disabled \
        -Dmacos-12-features=disabled \
        -Dmacos-cocoa-cb=disabled \
        -Dmacos-media-player=disabled \
        -Dmacos-touchbar=disabled \
        -Dswift-build=disabled \
        -Dswift-flags=disabled
    ninja -C "$srcdir/build"
}

package() {
    DESTDIR="$pkgdir" ninja install -C "$srcdir/build"
}
