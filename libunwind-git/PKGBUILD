pkgname=libunwind-git
pkgver=1.8.3.r146
pkgrel=1
pkgdesc="Portable and efficient C programming interface (API) to determine the call-chain of a program"
arch=('x86_64')
url="https://github.com/libunwind"
license=('MIT')
depends=('glibc' 'xz' 'zlib')
makedepends=('git' 'texlive-core')
provides=("libunwind=$pkgver")
conflicts=('libunwind')
options=('!debug' '!docs' '!emptydirs' '!lto' 'buildflags' 'ccache' 'makeflags')
source=(git+${url}/libunwind.git)
sha256sums=(SKIP)

pkgver() {
  cd "$srcdir/libunwind"
  _tag=$(git tag -l --sort -v:refname | grep -E '^v?[0-9\.]+$' | head -n1)
  _rev=$(git rev-list --count $_tag..HEAD)
  printf "%s.r%s" "$_tag" "$_rev" | sed 's/^v//'
}

build() {
  cd "$srcdir/libunwind"
  autoreconf -fi
  CC="$CC" CXX="$CXX" CXXPP="$CPP" LD="$LD" CFLAGS="$CFLAGS -fPIC" CPPFLAGS="$CPPFLAGS -fPIC" CXXFLAGS="$CXXFLAGS -fPIC" LDFLAGS="$LDFLAGS" \
  ./configure --prefix="/usr" --disable-shared --enable-static --disable-tests --disable-documentation --disable-ptrace --disable-coredump --disable-setjmp
  make ${MAKEFLAGS}

  cd "src/.libs"
  for lib in libunwind*.a; do
      so="${lib%.a}.so.8.2.0"
      if [ ! -f "$so" ]; then
          echo "Generating shared library: $so"
          clang -shared -fPIC -o "$so" $lib -Wl,-soname=$(basename "${so%.8.2.0}.so.8")
          ln -sf "$so" "${so%.8.2.0}.so"
          ln -sf "$so" "${so%.8.2.0}.so.8"
      fi
  done
}

package() {
  cd "$srcdir/libunwind"
  make DESTDIR="$pkgdir" install
}
