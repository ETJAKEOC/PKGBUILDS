pkgbase=llvm-project-git
pkgdesc="Meta LLVM/Clang stack: Clang, libc++, libc++abi, libunwind, lld, compiler-rt, clang-tools-extra, llvm-spirv, BOLT"
url="https://llvm.org/"
license=('Apache-2.0 WITH LLVM-exception')
arch=('x86_64')
pkgver=23.r533
pkgrel=1
pkgname=('llvm-ETJAKEOC')
makedepends=('git' 'cmake' 'ninja' 'python' 'python-setuptools' 'libffi' 'libedit' 'ncurses' 'libxml2' 'opencl-headers' 'z3' 'zstd')
depends=('zlib' 'zstd' 'libffi' 'libedit' 'ncurses' 'libxml2')
source=("git+https://github.com/llvm/llvm-project.git")
sha512sums=('SKIP')
options=('!debug' '!docs' '!emptydirs' '!lto' '!makeflags' '!staticlibs' '!strip' 'buildflags' 'ccache')

# Thank you, you worthless fucking cucks at LLVM for making this absurdly more difficult, go fuck yourselves!
pkgver() {
    cd "$srcdir/llvm-project"

    local _pkgver=$(
        git describe --tags --long |
        sed '
            s/^llvmorg-//;        # remove upstream tag prefix
            s/-init//;
            s/\([^-]*-g\)/r\1/;
            s/-/./g;
            s/\.g[0-9a-f]\{7,14\}$//
        '
    )

    if [[ -z "$_pkgver" ]]; then
        _pkgver=$(
            cd llvm-project/cmake/Modules &&
            awk -F 'MAJOR |MINOR |PATCH |)' '
                BEGIN { ORS="."; i=0 }
                /set\(LLVM_VERSION_/ {
                    print $2
                    i++
                    if (i==2) ORS=""
                }
                END { print "\n" }
            ' LLVMVersion.cmake
        )_r$(git rev-list --count HEAD)
    fi

    echo "${_pkgver}"
}

prepare() {
  cd "$srcdir/llvm-project"
  git submodule update --init --recursive
}

_cmake_flags=(
  -G Ninja -Wno-dev
  -DCMAKE_BUILD_TYPE=Release
  -DCMAKE_INSTALL_PREFIX=/usr
  -DCMAKE_INSTALL_LIBDIR=lib
  -DCMAKE_C_COMPILER="$CC"
  -DCMAKE_CXX_COMPILER="$CXX"
  -DCMAKE_CXX_STANDARD=17
  -DLLVM_USE_LINKER="$LD"
  -DCMAKE_C_FLAGS="-march=znver2 -mtune=znver2 -pipe -O3 -g0 -fPIC"
  -DCMAKE_CXX_FLAGS="-march=znver2 -mtune=znver2 -pipe -O3 -g0 -fPIC"
  -DCMAKE_EXE_LINKER_FLAGS="-fuse-ld=lld -O3"
  -DLLVM_DEFAULT_TARGET_TRIPLE=x86_64-pc-linux-gnu
  -DLLVM_HOST_TRIPLE=x86_64-pc-linux-gnu
  -DLLVM_TARGET_TRIPLE=x86_64-pc-linux-gnu
  -DCMAKE_C_COMPILER_TARGET=x86_64-pc-linux-gnu
  -DCMAKE_CXX_COMPILER_TARGET=x86_64-pc-linux-gnu
  -DCMAKE_ASM_COMPILER_TARGET=x86_64-pc-linux-gnu
  -DLLVM_BUILD_TESTS=OFF
  -DLLVM_INSTALL_PACKAGE_DIR=/usr/lib/cmake/llvm
  -DLLVM_ENABLE_LTO=OFF

  -DLIBCLC_TARGETS_TO_BUILD="amdgcn-mesa-mesa3d;clspv--"
  -DLLVM_ENABLE_PROJECTS="bolt;clang;clang-tools-extra;lld;llvm"
  -DLLVM_ENABLE_RUNTIMES="libcxx;libcxxabi;libunwind;compiler-rt;libclc"
  -DLLVM_TARGETS_TO_BUILD="X86;AMDGPU;SPIRV;AArch64;ARM;WebAssembly"
  -DLLVM_EXPERIMENTAL_TARGETS_TO_BUILD=DirectX
  -DLLVM_OPTIMIZED_TABLEGEN=ON
  -DLLVM_PARALLEL_LINK_JOBS=4

  -DCLANG_LINK_CLANG_DYLIB=ON
  -DLLVM_CCACHE_BUILD=ON
  -DLLVM_ENABLE_RTTI=ON
  -DLLVM_ENABLE_RPATH=ON
  -DLLVM_ENABLE_EH=ON
  -DLLVM_ENABLE_FFI=ON
  -DLLVM_ENABLE_PIC=ON
  -DLLVM_ENABLE_LIBXML2=ON
  -DLLVM_ENABLE_THREADS=ON
  -DLLVM_ENABLE_ZLIB=ON
  -DLLVM_ENABLE_ZSTD=ON
  -DLLVM_INSTALL_BINUTILS_SYMLINKS=ON
  -DLLVM_INSTALL_CCTOOLS_SYMLINKS=ON
  -DLLVM_INSTALL_UTILS=ON
  -DLLVM_LINK_LLVM_DYLIB=ON
  -DLLVM_USE_HOST_TOOLS=ON
  -DCOMPILER_RT_DEFAULT_TARGET_ONLY=OFF
  -DCOMPILER_RT_SKIP_RUNTIME_CHECKS=ON
  -DCOMPILER_RT_BUILD_BUILTINS=ON
  -DCOMPILER_RT_BUILD_SANITIZERS=ON
  -DCOMPILER_RT_BUILD_PROFILE=ON
  -DCOMPILER_RT_BUILD_XRAY=OFF
  -DCOMPILER_RT_BUILD_LIBFUZZER=OFF
  -DCOMPILER_RT_BUILD_MEMPROF=OFF
  -DLIBCXX_ENABLE_SHARED=ON
  -DLIBCXXABI_ENABLE_SHARED=ON
  -DLIBUNWIND_ENABLE_SHARED=ON
  -DLIBUNWIND_INSTALL_LIBRARY=ON

  -DCLANG_ENABLE_STATIC_ANALYZER=OFF
  -DLLVM_BUILD_BENCHMARKS=OFF
  -DLLVM_BUILD_DOCS=OFF
  -DLLVM_BUILD_EXAMPLES=OFF
  -DLLVM_BUILD_LLVM_DYLIB=ON
  -DLLVM_ENABLE_ASSERTIONS=OFF
  -DLLVM_ENABLE_BINDINGS=OFF
  -DLLVM_ENABLE_DUMP=OFF
  -DLLVM_ENABLE_EXPENSIVE_CHECKS=OFF
  -DLLVM_ENABLE_Z3_SOLVER=OFF
  -DLLVM_INCLUDE_BENCHMARKS=OFF
  -DLLVM_INCLUDE_DOCS=OFF
  -DLLVM_INCLUDE_EXAMPLES=OFF
  -DLLVM_INCLUDE_TESTS=OFF
)

build() {
  export LD_LIBRARY_PATH="$srcdir/_build/lib"
  ulimit -s unlimited
  cmake -B "$srcdir/_build" -S "$srcdir/llvm-project/llvm" "${_cmake_flags[@]}"
  ninja -C "$srcdir/_build"
  DESTDIR="$srcdir/install" ninja -j4 -C "$srcdir/_build" install
}

package() {
  provides=('llvm-libs-git' 'llvm-libs' 'llvm-git' 'llvm' 'clang-git' 'clang' 'compiler-rt-git' 'compiler-rt' 'lld-git' 'lld' 'clang-tools-extra-git' 'clang-tools-extra' 'libcxx-git' 'libcxx' 'libcxxabi-git' 'libcxxabi' 'libunwind-git' 'libunwind' 'llvm-spirv-git' 'llvm-spirv' 'bolt-git' 'bolt')
  conflicts=($provides)

  mkdir -p "$pkgdir/usr/lib/pkgconfig"
  cp -a "$srcdir/install/usr/." "$pkgdir/usr/"
  tee "$pkgdir/usr/lib/pkgconfig/libunwind.pc" <<'EOF'
prefix=/usr
exec_prefix=${prefix}
libdir=${exec_prefix}/lib
includedir=${prefix}/include

Name: libunwind
Description: LLVM libunwind
Version: 23.0.0
Libs: -L${libdir} -lunwind
Cflags: -I${includedir}
EOF
}
